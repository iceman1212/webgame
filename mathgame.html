<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>神奇数学气球大战 v2.3</title>
  <style>
    body { margin:0; padding:0; background:#87cefa; overflow:hidden; font-family:"Arial",sans-serif; }
    #gameCanvas { display:block; margin:20px auto; background:linear-gradient(to bottom,#a0e3f7,#ffffff); border-radius:16px; box-shadow:0 0 20px rgba(0,0,0,0.2); }
    #info { position:absolute; top:10px; width:100%; text-align:center; color:#fff; font-size:22px; text-shadow:2px 2px 4px rgba(0,0,0,0.5); pointer-events:none; }
    #info span { background:rgba(0,0,0,0.3); padding:6px 12px; border-radius:8px; margin:0 8px; display:inline-block; }
    #startBtn { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); padding:16px 32px; background:#fdd835; border:3px solid #fbc02d; border-radius:12px; font-size:26px; font-weight:bold; color:#333; cursor:pointer; box-shadow:0 0 10px rgba(0,0,0,0.3); transition:transform 0.1s ease; }
    #startBtn:hover { transform:translate(-50%,-50%) scale(1.08); }
    #overlay { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,0.6); visibility:hidden; }
    #messageBox { background:#fff; padding:24px; border-radius:12px; text-align:center; box-shadow:0 0 20px rgba(0,0,0,0.3); max-width:80%; }
    #messageBox h1 { margin:0 0 16px; color:#00796b; font-size:32px; }
    #messageBox p { margin:8px 0; font-size:20px; color:#555; }
    #messageBox button { margin-top:16px; padding:10px 20px; background:#00796b; color:#fff; border:none; border-radius:8px; font-size:20px; cursor:pointer; transition:background 0.2s ease; }
    #messageBox button:hover { background:#004d40; }
  </style>
</head>
<body>
  <div id="info">
    <span>得分:<span id="score">0</span></span>
    <span>生命:<span id="lives">3</span></span>
    <span>题目:<span id="questionText">-</span></span>
  </div>
  <canvas id="gameCanvas" width="480" height="640"></canvas>
  <button id="startBtn">开始游戏</button>
  <div id="overlay">
    <div id="messageBox">
      <h1 id="messageTitle">游戏结束</h1>
      <p id="messageContent">得分:0</p>
      <button id="restartBtn">重新开始</button>
    </div>
  </div>
  <script>
    const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");
    const scoreEl=document.getElementById("score"),livesEl=document.getElementById("lives"),questionEl=document.getElementById("questionText");
    const startBtn=document.getElementById("startBtn"),overlay=document.getElementById("overlay");
    const messageTitle=document.getElementById("messageTitle"),messageContent=document.getElementById("messageContent"),restartBtn=document.getElementById("restartBtn");
    let player={x:canvas.width/2-20,y:canvas.height-60,size:40,speed:6};
    let balloons=[],currentQuestion=null,score=0,lives=3,gameInterval=null,spawnInterval=null,isRunning=false;
    const BALLOON_RADIUS=28;
    const AudioContext=window.AudioContext||window.webkitAudioContext;const audioCtx=new AudioContext();
    function startBackgroundMusic(){const notes=[261.63,293.66,329.63,349.23];let index=0;function playNext(){if(!isRunning)return;const now=audioCtx.currentTime;const osc=audioCtx.createOscillator();const gain=audioCtx.createGain();osc.type='sine';osc.frequency.setValueAtTime(notes[index],now);gain.gain.setValueAtTime(0.05,now);osc.connect(gain);gain.connect(audioCtx.destination);osc.start(now);osc.stop(now+0.3);index=(index+1)%notes.length;setTimeout(playNext,400);}playNext();}
    function playPopSound(){const now=audioCtx.currentTime;const osc1=audioCtx.createOscillator(),osc2=audioCtx.createOscillator(),gain=audioCtx.createGain();osc1.type='triangle';osc2.type='triangle';osc1.frequency.setValueAtTime(880,now);osc2.frequency.setValueAtTime(660,now);gain.gain.setValueAtTime(0.12,now);osc1.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);osc1.start(now);osc2.start(now);osc1.frequency.linearRampToValueAtTime(440,now+0.15);osc2.frequency.linearRampToValueAtTime(330,now+0.15);osc1.stop(now+0.15);osc2.stop(now+0.15);}
    function playFailSound(){const now=audioCtx.currentTime;const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();osc.type='sawtooth';osc.frequency.setValueAtTime(200,now);gain.gain.setValueAtTime(0.15,now);osc.connect(gain);gain.connect(audioCtx.destination);osc.start(now);osc.frequency.exponentialRampToValueAtTime(50,now+0.4);gain.gain.linearRampToValueAtTime(0,now+0.4);osc.stop(now+0.4);}
    function generateQuestion(){const a=Math.floor(Math.random()*9)+1,b=Math.floor(Math.random()*9)+1,ops=['+','-','*'],op=ops[Math.floor(Math.random()*ops.length)];let ans;if(op==='+')ans=a+b;if(op==='-')ans=a-b;if(op==='*')ans=a*b;currentQuestion={text:`${a} ${op} ${b} = ?`,answer:ans};questionEl.textContent=currentQuestion.text;}
    function spawnBalloons(){const correct=currentQuestion.answer;let choices=[correct];while(choices.length<4){let fake=correct+(Math.floor(Math.random()*9)-4);if(fake!==correct&&fake>=0&&!choices.includes(fake))choices.push(fake);}shuffleArray(choices);balloons=choices.map((val,idx)=>{const xPos=idx*(canvas.width/4)+(canvas.width/8)-BALLOON_RADIUS;return{x:xPos,y:-(BALLOON_RADIUS*2+Math.random()*80),val:val,color:`hsl(${Math.random()*360},80%,65%)`,speed:1+Math.random()*1.5,floatOffset:Math.random()*Math.PI*2};});}
    function shuffleArray(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}
    function drawPlayer(){const x=player.x+player.size/2,y=player.y+player.size/2;ctx.save();ctx.translate(x,y);ctx.fillStyle='#ff69b4';ctx.beginPath();for(let i=0;i<5;i++){ctx.lineTo(Math.cos((18+i*72)/180*Math.PI)*player.size/2,-Math.sin((18+i*72)/180*Math.PI)*player.size/2);ctx.lineTo(Math.cos((54+i*72)/180*Math.PI)*player.size/4,-Math.sin((54+i*72)/180*Math.PI)*player.size/4);}ctx.closePath();ctx.fill();ctx.restore();}
    function drawBalloons(){ctx.font='18px Arial';balloons.forEach(balloon=>{const sway=Math.sin((Date.now()/500)+balloon.floatOffset)*8;const bx=balloon.x+sway,by=balloon.y;ctx.beginPath();ctx.arc(bx+BALLOON_RADIUS+3,by+BALLOON_RADIUS+3,BALLOON_RADIUS,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,0.1)';ctx.fill();ctx.beginPath();ctx.arc(bx+BALLOON_RADIUS,by+BALLOON_RADIUS,BALLOON_RADIUS,0,Math.PI*2);ctx.fillStyle=balloon.color;ctx.fill();ctx.beginPath();ctx.arc(bx+BALLOON_RADIUS-8,by+BALLOON_RADIUS-12,BALLOON_RADIUS/4,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,0.7)';ctx.fill();ctx.strokeStyle='#888';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(bx+BALLOON_RADIUS,by+BALLOON_RADIUS*2);ctx.lineTo(bx+BALLOON_RADIUS,by+BALLOON_RADIUS*2+20);ctx.stroke();ctx.fillStyle='#ffffff';ctx.textAlign='center';ctx.fillText(balloon.val,bx+BALLOON_RADIUS,by+BALLOON_RADIUS+6);});}
    function update(){ctx.clearRect(0,0,canvas.width,canvas.height);drawBalloons();drawPlayer();balloons.forEach(balloon=>{balloon.y+=balloon.speed;if(balloon.y>canvas.height){if(balloon.val===currentQuestion.answer)loseLife();removeBalloon(balloon);}});balloons.forEach(balloon=>{const sway=Math.sin((Date.now()/500)+balloon.floatOffset)*8;const bx=balloon.x+sway,by=balloon.y;if(player.x<bx+BALLOON_RADIUS*2&&player.x+player.size>bx&&player.y<by+BALLOON_RADIUS*2&&player.y+player.size>by){if(balloon.val===currentQuestion.answer){score+=10;playPopSound();}else{loseLife();playFailSound();}updateInfo();removeBalloon(balloon);}});}  
    function removeBalloon(balloon){const idx=balloons.indexOf(balloon);if(idx>-1)balloons.splice(idx,1);if(balloons.length===0)prepareNextRound();}
    function prepareNextRound(){generateQuestion();spawnBalloons();updateInfo();}
    function loseLife(){lives-=1;updateInfo();if(lives<=0)endGame();}
    function updateInfo(){scoreEl.textContent=score;livesEl.textContent=lives;}
    function endGame(){clearInterval(gameInterval);clearInterval(spawnInterval);isRunning=false;messageTitle.textContent='游戏结束';messageContent.textContent=`得分:${score}`;overlay.style.visibility='visible';}
    document.addEventListener('keydown',e=>{if(!isRunning)return;if(e.key==='ArrowLeft'||e.key==='a'){player.x=Math.max(0,player.x-player.speed);}else if(e.key==='ArrowRight'||e.key==='d'){player.x=Math.min(canvas.width-player.size,player.x+player.speed);}});
    canvas.addEventListener('mousemove',e=>{if(!isRunning)return;const rect=canvas.getBoundingClientRect();let mx=e.clientX-rect.left;player.x=Math.min(canvas.width-player.size,Math.max(0,mx-player.size/2));});
    startBtn.onclick=()=>{if(isRunning)return;isRunning=true;startBtn.style.display='none';generateQuestion();spawnBalloons();updateInfo();gameInterval=setInterval(update,20);spawnInterval=setInterval(()=>{if(balloons.length===0)spawnBalloons();},3500);if(audioCtx.state==='suspended')audioCtx.resume();startBackgroundMusic();};
    restartBtn.onclick=()=>{overlay.style.visibility='hidden';score=0;lives=3;player.x=canvas.width/2-20;generateQuestion();spawnBalloons();updateInfo();isRunning=true;gameInterval=setInterval(update,20);spawnInterval=setInterval(()=>{if(balloons.length===0)spawnBalloons();},3500);if(audioCtx.state==='suspended')audioCtx.resume();startBackgroundMusic();};
  </script>
</body>
</html>
